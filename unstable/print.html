<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Colmena (Unstable)</title>
                <meta name="robots" content="noindex" />
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="favicon.svg">
                        <link rel="shortcut icon" href="favicon.png">
                <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
                <link rel="stylesheet" href="css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="tutorial/index.html"><strong aria-hidden="true">2.</strong> Tutorial</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="tutorial/flakes.html"><strong aria-hidden="true">2.1.</strong> Usage with Flakes</a></li><li class="chapter-item expanded "><a href="tutorial/migration.html"><strong aria-hidden="true">2.2.</strong> Migrating from NixOps/morph</a></li></ol></li><li class="chapter-item expanded "><a href="features/index.html"><strong aria-hidden="true">3.</strong> Features</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="features/tags.html"><strong aria-hidden="true">3.1.</strong> Node Tagging</a></li><li class="chapter-item expanded "><a href="features/apply-local.html"><strong aria-hidden="true">3.2.</strong> Local Deployment</a></li><li class="chapter-item expanded "><a href="features/keys.html"><strong aria-hidden="true">3.3.</strong> Secrets</a></li><li class="chapter-item expanded "><a href="features/eval.html"><strong aria-hidden="true">3.4.</strong> Ad Hoc Evaluation</a></li><li class="chapter-item expanded "><a href="features/parallelism.html"><strong aria-hidden="true">3.5.</strong> Parallelism</a></li><li class="chapter-item expanded "><a href="features/remote-builds.html"><strong aria-hidden="true">3.6.</strong> Remote Builds</a></li></ol></li><li class="chapter-item expanded "><a href="examples/index.html"><strong aria-hidden="true">4.</strong> Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="examples/multi-arch.html"><strong aria-hidden="true">4.1.</strong> Multi-Architecture Deployments</a></li></ol></li><li class="chapter-item expanded "><a href="reference/index.html"><strong aria-hidden="true">5.</strong> Reference</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="reference/deployment.html"><strong aria-hidden="true">5.1.</strong> Deployment Options</a></li><li class="chapter-item expanded "><a href="reference/meta.html"><strong aria-hidden="true">5.2.</strong> Meta Options</a></li><li class="chapter-item expanded "><a href="reference/cli.html"><strong aria-hidden="true">5.3.</strong> Command Line Arguments</a></li></ol></li><li class="chapter-item expanded "><a href="contributing.html"><strong aria-hidden="true">6.</strong> Contributing</a></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">Colmena (Unstable)</h1>

                    <div class="right-buttons">
                                                <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        <a href="https://github.com/zhaofengli/colmena" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                                                
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <!-- Generated from version 0.3.0-pre (apiVersion=0.3, unstable=True) -->
<h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<p><strong>Colmena</strong> is a simple, stateless <a href="https://nixos.org">NixOS</a> deployment tool modeled after <a href="https://github.com/NixOS/nixops">NixOps</a> and <a href="https://github.com/DBCDK/morph">morph</a>, written in Rust.
It's a thin wrapper over Nix commands like <code>nix-instantiate</code> and <code>nix-copy-closure</code>, and supports parallel deployment.</p>
<p>Interested? Get started <a href="./tutorial/index.html">here</a>!</p>
<pre><div class="hljs">$ <b>colmena apply --on @tag-a</b>
[INFO ] Enumerating nodes...
[INFO ] Selected 7 out of 45 hosts.
  (...) âœ… 0s Build successful
  <b>sigma</b> ðŸ•— 7s copying path '/nix/store/h6qpk8rwm3dh3zsl1wlj1jharzf8aw9f-unit-haigha-agent.service' to 'ssh://root@sigma.redacted'...
  <b>theta</b> âœ… 7s Activation successful
  <b>gamma</b> ðŸ•˜ 8s Starting...
  <b>alpha</b> âœ… 1s Activation successful
<b>epsilon</b> ðŸ•— 7s copying path '/nix/store/fhh4rfixny8b21l6jqzk7nqwxva5k20h-nixos-system-epsilon-20.09pre-git' to 'ssh://root@epsilon.redacted'...
   <b>beta</b> ðŸ•— 7s removing obsolete file /boot/kernels/z28ayg10kpnlrz0s2qrb9pzv82lc20s2-initrd-linux-5.4.89-initrd
  <b>kappa</b> âœ… 2s Activation successful
</div></pre>
<!-- UNSTABLE_BEGIN -->
<p>You are currently reading <strong>the unstable version</strong> of the Colmena Manual, built against the tip of <a href="https://github.com/zhaofengli/colmena">the development branch</a>.
Features described here will eventually become a part of <strong>version 0.3</strong>.</p>
<!-- UNSTABLE_END -->
<h2 id="links"><a class="header" href="#links">Links</a></h2>
<ul>
<li><a href="https://github.com/zhaofengli/colmena">GitHub</a></li>
<li><a href="reference/deployment.html">Deployment Options Reference</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><!-- Generated from version 0.3.0-pre (apiVersion=0.3, unstable=True) -->
<h1 id="tutorial"><a class="header" href="#tutorial">Tutorial</a></h1>
<h2 id="installation"><a class="header" href="#installation">Installation</a></h2>
<!-- UNSTABLE_BEGIN -->
<!-- To install the latest stable version, read [the corresponding Manual](https://zhaofengli.github.io/colmena/stable) for instructions. -->
<p>To install the latest development version to the user profile, use the following command:</p>
<pre><code class="language-bash">nix-env -if https://github.com/zhaofengli/colmena/tarball/main
</code></pre>
<h3 id="unstable-binary-cache"><a class="header" href="#unstable-binary-cache">Unstable Binary Cache</a></h3>
<p>A public binary cache is available at <a href="https://colmena.cachix.org">https://colmena.cachix.org</a>, courtesy of Cachix.
This binary cache contains unstable versions of Colmena built by <a href="https://github.com/zhaofengli/colmena/actions">GitHub Actions</a>.</p>
<!-- UNSTABLE_END -->
<h2 id="basic-configuration"><a class="header" href="#basic-configuration">Basic Configuration</a></h2>
<p><em>If you use Nix Flakes, follow the Flake version <a href="tutorial/flakes.html">here</a>.</em></p>
<p>Colmena should work with your existing NixOps and morph configurations with minimal modification (see <a href="tutorial/migration.html">Migrating from NixOps/morph</a>).</p>
<p>Here is a sample <code>hive.nix</code> with two nodes, with some common configurations applied to both nodes:</p>
<pre><code class="language-nix">{
  meta = {
    # Override to pin the Nixpkgs version (recommended). This option
    # accepts one of the following:
    # - A path to a Nixpkgs checkout
    # - The Nixpkgs lambda (e.g., import &lt;nixpkgs&gt;)
    # - An initialized Nixpkgs attribute set
    nixpkgs = &lt;nixpkgs&gt;;

    # You can also override Nixpkgs by node!
    nodeNixpkgs = {
      node-b = ./another-nixos-checkout;
    };

    # If your Colmena host has nix configured to allow for remote builds
    # (for nix-daemon, your user being included in trusted-users)
    # you can set a machines file that will be passed to the underlying
    # nix-store command during derivation realization as a builders option.
    # For example, if you support multiple orginizations each with their own
    # build machine(s) you can ensure that builds only take place on your
    # local machine and/or the machines specified in this file.
    # machinesFile = ./machines.client-a;
  };

  defaults = { pkgs, ... }: {
    # This module will be imported by all hosts
    environment.systemPackages = with pkgs; [
      vim wget curl
    ];

    # By default, Colmena will replace unknown remote profile
    # (unknown means the profile isn't in the nix store on the
    # host running Colmena) during apply (with the default goal,
    # boot, and switch).
    # If you share a hive with others, or use multiple machines,
    # and are not careful to always commit/push/pull changes
    # you can accidentaly overwrite a remote profile so in those
    # scenarios you might want to change this default to false. 
    # deployment.replaceUnknownProfiles = true;
  };

  host-a = { name, nodes, ... }: {
    # The name and nodes parameters are supported in Colmena,
    # allowing you to reference configurations in other nodes.
    networking.hostName = name;
    time.timeZone = nodes.host-b.config.time.timeZone;

    boot.loader.grub.device = &quot;/dev/sda&quot;;
    fileSystems.&quot;/&quot; = {
      device = &quot;/dev/sda1&quot;;
      fsType = &quot;ext4&quot;;
    };
  };

  host-b = {
    # Like NixOps and Morph, Colmena will attempt to connect to
    # the remote host using the attribute name by default. You
    # can override it like:
    deployment.targetHost = &quot;host-b.mydomain.tld&quot;;

    # It's also possible to override the target SSH port.
    # For further customization, use the SSH_CONFIG_FILE
    # environment variable to specify a ssh_config file.
    deployment.targetPort = 1234;

    # Override the default for this target host
    deployment.replaceUnknownProfiles = false;

    # You can filter hosts by tags with --on @tag-a,@tag-b.
    # In this example, you can deploy to hosts with the &quot;web&quot; tag using:
    #    colmena apply --on @web
    # You can use globs in tag matching as well:
    #    colmena apply --on '@infra-*'
    deployment.tags = [ &quot;web&quot; &quot;infra-lax&quot; ];

    time.timeZone = &quot;America/Los_Angeles&quot;;

    boot.loader.grub.device = &quot;/dev/sda&quot;;
    fileSystems.&quot;/&quot; = {
      device = &quot;/dev/sda1&quot;;
      fsType = &quot;ext4&quot;;
    };
  };
}
</code></pre>
<p>The full set of <code>deployment</code> options can be found <a href="tutorial/../reference/deployment.html">here</a>.</p>
<p>Now you are ready to use Colmena! To build the configuration:</p>
<pre><code class="language-bash">colmena build
</code></pre>
<p>To build and deploy to all nodes:</p>
<pre><code class="language-bash">colmena apply
</code></pre>
<h2 id="next-steps"><a class="header" href="#next-steps">Next Steps</a></h2>
<ul>
<li>Head to the <a href="tutorial/../features/index.html">Features</a> section to see what else Colmena can do.</li>
<li>Read more about options available in Colmena in the <a href="tutorial/../reference/index.html">Reference</a> section.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><!-- Generated from version 0.3.0-pre (apiVersion=0.3, unstable=True) -->
<h1 id="usage-with-flakes"><a class="header" href="#usage-with-flakes">Usage with Flakes</a></h1>
<h2 id="installation-1"><a class="header" href="#installation-1">Installation</a></h2>
<!-- UNSTABLE_BEGIN -->
<!-- To install the latest stable version, read [the corresponding Manual](https://zhaofengli.github.io/colmena/stable) for instructions. -->
<p>To quickly try Colmena out, use the following command to enter an ephemeral environment with the latest development version of <code>colmena</code>:</p>
<pre><code class="language-bash">nix shell github:zhaofengli/colmena
</code></pre>
<p>To install Colmena to the user profile, use the following command:</p>
<pre><code class="language-bash">nix-env -if https://github.com/zhaofengli/colmena/tarball/main
</code></pre>
<p>You can also add <code>github:zhaofengli/colmena</code> as an input in your Flake and add the <code>colmena</code> package to your <code>devShell</code>.</p>
<h3 id="unstable-binary-cache-1"><a class="header" href="#unstable-binary-cache-1">Unstable Binary Cache</a></h3>
<p>A public binary cache is available at <a href="https://colmena.cachix.org">https://colmena.cachix.org</a>, courtesy of Cachix.
This binary cache contains unstable versions of Colmena built by <a href="https://github.com/zhaofengli/colmena/actions">GitHub Actions</a>.</p>
<!-- UNSTABLE_END -->
<h2 id="basic-configuration-1"><a class="header" href="#basic-configuration-1">Basic Configuration</a></h2>
<p>Colmena reads the <code>colmena</code> output in your Flake.</p>
<p>Here is a short example:</p>
<pre><code class="language-nix">{
  inputs = {
    nixpkgs.url = &quot;github:NixOS/nixpkgs/nixos-unstable&quot;;
  };
  outputs = { nixpkgs, ... }: {
    colmena = {
      meta = {
        nixpkgs = import nixpkgs {
          system = &quot;x86_64-linux&quot;;
        };
      };

      host-a = { name, nodes, pkgs, ... }: {
        boot.isContainer = true;
        time.timeZone = nodes.host-b.config.time.timeZone;
      };
      host-b = {
        deployment = {
          targetHost = &quot;somehost.tld&quot;;
          targetPort = 1234;
          targetUser = &quot;luser&quot;;
        };
        boot.isContainer = true;
        time.timeZone = &quot;America/Los_Angeles&quot;;
      };
    };
  };
}
</code></pre>
<p>The full set of <code>deployment</code> options can be found <a href="tutorial/../reference/deployment.html">here</a>.
You can also check out the example in <a href="tutorial/index.html">the main tutorial</a> for some inspiration.</p>
<p>Now you are ready to use Colmena! To build the configuration:</p>
<pre><code class="language-bash">colmena build
</code></pre>
<p>To build and deploy to all nodes:</p>
<pre><code class="language-bash">colmena apply
</code></pre>
<h2 id="next-steps-1"><a class="header" href="#next-steps-1">Next Steps</a></h2>
<ul>
<li>Head to the <a href="tutorial/../features/index.html">Features</a> section to see what else Colmena can do.</li>
<li>Read more about options available in Colmena in the <a href="tutorial/../reference/index.html">Reference</a> section.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><!-- Generated from version 0.3.0-pre (apiVersion=0.3, unstable=True) -->
<h1 id="migrating-from-nixopsmorph"><a class="header" href="#migrating-from-nixopsmorph">Migrating from NixOps/morph</a></h1>
<p>Colmena should work with existing NixOps and morph configurations with minimal modification.
That said, there are a few things to look out for:</p>
<h2 id="colmena-deploys-to-existing-nixos-hosts"><a class="header" href="#colmena-deploys-to-existing-nixos-hosts">Colmena deploys to <em>existing</em> NixOS hosts</a></h2>
<p>Unlike NixOps which can be configured to manage the entire lifecycles of NixOS machines (e.g., spinning up AWS EC2 instances), Colmena can only deploy to hosts already running NixOS.</p>
<h2 id="network-vs-meta"><a class="header" href="#network-vs-meta"><code>network</code> vs <code>meta</code></a></h2>
<p>Colmena accepts <a href="tutorial/../reference/meta.html">a set of options</a> to configure the deployment itself as <code>meta</code>.
For NixOps compatibility, it also accepts <code>network</code> as an alias so you don't have to change your existing configuration.</p>
<h2 id="pinning-nixpkgs"><a class="header" href="#pinning-nixpkgs">Pinning Nixpkgs</a></h2>
<p>You can pin the nixpkgs version by setting <code>meta.nixpkgs</code> (or <code>network.nixpkgs</code> if you use the alias).
This is required if you <a href="tutorial/flakes.html">use Flakes</a>.
The options accepts one of the following:</p>
<ul>
<li>Path to a Nixpkgs checkout <em>(not supported in Flakes)</em>
<ul>
<li>Example: <code>./nixpkgs</code></li>
</ul>
</li>
<li>The Nixpkgs lambda returned by importing its <code>default.nix</code> <em>(not supported in Flakes)</em>
<ul>
<li>Example: <code>import ./nixpkgs</code></li>
</ul>
</li>
<li>A fully initialized Nixpkgs attribute set
<ul>
<li>Example: <code>import ./nixpkgs { system = &quot;x86_64-linux&quot;; }</code></li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><!-- Generated from version 0.3.0-pre (apiVersion=0.3, unstable=True) -->
<h1 id="features"><a class="header" href="#features">Features</a></h1>
<p>This section introduces the main features in Colmena:</p>
<ul>
<li><strong><a href="features/tags.html">Node Tagging</a></strong> - Deploying to a subset of tagged nodes</li>
<li><strong><a href="features/apply-local.html">Local Deployment</a></strong> - Deploying to the host running Colmena itself</li>
<li><strong><a href="features/keys.html">Secrets</a></strong> - Deploying sensitive files separate from the main configuration</li>
<li><strong><a href="features/eval.html">Ad Hoc Evaluation</a></strong> - Evaluating a Nix expression with access to your configuration</li>
<li><strong><a href="features/parallelism.html">Parallelism</a></strong> - Controlling how Colmena parallelizes the deployment process</li>
<li><strong><a href="features/remote-builds.html">Remote Builds</a></strong> - Building system profiles on remote machines</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><!-- Generated from version 0.3.0-pre (apiVersion=0.3, unstable=True) -->
<h1 id="node-tagging"><a class="header" href="#node-tagging">Node Tagging</a></h1>
<p>With node tags, you can quickly select a subset of nodes for deployment.
You can specify tags using the <code>deployment.tags</code> option:</p>
<pre><code class="language-nix">{
  alpha = { pkgs, ... }: {
    deployment.tags = [ &quot;web&quot; &quot;infra-lax&quot; ];

    # ... Rest of configuration ...
  };
  beta = { pkgs, ... }: {
    deployment.tags = [ &quot;infra-sfo&quot; ];

    # ... Rest of configuration ...
  };
}
</code></pre>
<p>You can filter hosts by tags or names with <code>--on</code>, which accepts a comma-separated list of node names or @tags.</p>
<p>To select all nodes with <code>web</code>:</p>
<pre><code class="language-console">$ colmena apply --on @web
</code></pre>
<p>Wildcards are supported as well.
To select all nodes with a tag beginning with <code>infra-</code>:</p>
<pre><code class="language-console">$ colmena apply --on '@infra-*'
</code></pre>
<p><em>(Note the quotes around the argument)</em></p>
<div style="break-before: page; page-break-before: always;"></div><!-- Generated from version 0.3.0-pre (apiVersion=0.3, unstable=True) -->
<h1 id="local-deployment"><a class="header" href="#local-deployment">Local Deployment</a></h1>
<p>For some machines, you may still want to stick with the manual <code>nixos-rebuild</code>-type of workflow.
Colmena allows you to build and activate configurations on the host running Colmena itself, provided that:</p>
<ol>
<li>The node must be running NixOS.</li>
<li>The node must have <code>deployment.allowLocalDeployment</code> set to <code>true</code>.</li>
<li>The node's <em>attribute name</em> must match the hostname of the machine.</li>
</ol>
<p>If you invoke <code>apply-local</code> with <code>--sudo</code>, Colmena will attempt to elevate privileges with <code>sudo</code> if it's not run as root.
You may also find it helpful to set <code>deployment.targetHost</code> to <code>null</code> if you don't intend to deploy to the host via SSH.</p>
<p>As an example, the following <code>hive.nix</code> includes a node (<code>laptop</code>) that is meant to be only deployed with <code>apply-local</code>:</p>
<pre><code class="language-nix">{
  meta = {
    nixpkgs = ./deps/nixpkgs-stable;

    # I'd like to use the unstable version of Nixpkgs on
    # my desktop machines.
    nodeNixpkgs = {
      laptop = ./deps/nixpkgs-unstable;
    };
  };

  # This attribute name must match the output of `hostname` on your machine
  laptop = { name, nodes, ... }: {
    networking.hostName = &quot;laptop&quot;;

    deployment = {
      # Allow local deployment with `colmena apply-local`
      allowLocalDeployment = true;

      # Disable SSH deployment. This node will be skipped in a
      # normal`colmena apply`.
      targetHost = null;
    };

    # ... Rest of configuration ...
  };

  server-a = { pkgs, ... }: {
    # This node will use the default Nixpkgs checkout specified
    # in `meta.nixpkgs`.

    # ... Rest of configuration ...
  };
}
</code></pre>
<p>On <code>laptop</code>, run <code>colmena apply-local --sudo</code> to activate the configuration.</p>
<div style="break-before: page; page-break-before: always;"></div><!-- Generated from version 0.3.0-pre (apiVersion=0.3, unstable=True) -->
<h1 id="secrets"><a class="header" href="#secrets">Secrets</a></h1>
<p>Colmena allows you to upload secret files that will not be stored in the Nix store to nodes.
It implements a subset of the <code>deployment.keys</code> options supported by NixOps.</p>
<p>For example, to deploy DNS-01 credentials for use with <code>security.acme</code>:</p>
<pre><code class="language-nix">{
  shared-box = {
    security.acme.certs.&quot;my-site.tld&quot;.credentialsFile = &quot;/run/keys/acme-credentials.secret&quot;;
    deployment.keys.&quot;acme-credentials.secret&quot; = {
      # Alternatively, `text` (string) or `keyFile` (path to file)
      # may be specified.
      keyCommand = [ &quot;vault&quot; &quot;read&quot; &quot;-field=env&quot; &quot;secret/dns01&quot; ];

      destDir = &quot;/run/keys&quot;;       # Default: /run/keys
      user = &quot;acme&quot;;               # Default: root
      group = &quot;nginx&quot;;             # Default: root
      permissions = &quot;0640&quot;;        # Default: 0600

      uploadAt = &quot;pre-activation&quot;; # Default: pre-activation, Alternative: post-activation
    };
    # Rest of configuration...
  };
}
</code></pre>
<p>Take note that if you use the default path (<code>/run/keys</code>), the secret files are only stored in-memory and will not survive reboots.
To upload your secrets without performing a full deployment, use <code>colmena upload-keys</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><!-- Generated from version 0.3.0-pre (apiVersion=0.3, unstable=True) -->
<h1 id="ad-hoc-evaluation"><a class="header" href="#ad-hoc-evaluation">Ad Hoc Evaluation</a></h1>
<p>Sometimes you may want to extract values from your Hive configuration for consumption in another program (e.g., <a href="https://github.com/octodns/octodns">OctoDNS</a>).
To do that, create a <code>.nix</code> file with a lambda:</p>
<pre><code class="language-nix">{ nodes, pkgs, lib, ... }:
# Feels like a NixOS module - But you can return any JSON-serializable value
lib.attrsets.mapAttrs (k: v: v.config.deployment.targetHost) nodes
</code></pre>
<p>Then you can obtain a JSON output with:</p>
<pre><code class="language-console">$ colmena eval target-hosts.nix
{&quot;alpha&quot;:&quot;fd12:3456::1&quot;,&quot;beta&quot;:&quot;fd12:3456::2&quot;}
</code></pre>
<p>You can also specify an expression directly on the command line:</p>
<pre><code class="language-console">$ colmena eval -E '{ nodes, pkgs, lib, ... }: ...'
</code></pre>
<h2 id="instantiation"><a class="header" href="#instantiation">Instantiation</a></h2>
<p>You may directly instantiate an expression that evaluates to a derivation:</p>
<pre><code class="language-console">$ colmena eval --instantiate -E '{ nodes, ... }: nodes.alpha.config.boot.kernelPackages.kernel'
/nix/store/7ggmhnwvywrqcd1z2sdpan8afz55sw7z-linux-5.14.14.drv
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><!-- Generated from version 0.3.0-pre (apiVersion=0.3, unstable=True) -->
<h1 id="parallelism"><a class="header" href="#parallelism">Parallelism</a></h1>
<p>Colmena is built from the ground up to support parallel deployments.
Evaluation, build, and deployment of node configurations can happen at the same time.
This parallelism can be controlled primarily through two flags:</p>
<p><strong><code>--limit &lt;number&gt;</code></strong></p>
<p>Number of hosts to deploy at once in the final step (pushing closures and activating new profiles). The default value is 10.</p>
<p><strong><code>--eval-node-limit &lt;number&gt;</code></strong></p>
<p>By default, Colmena will automatically determine the maximum number of nodes to evaluate at the same time according to available RAM.
This flag allows you to set the limit to a predetermined value.</p>
<div style="break-before: page; page-break-before: always;"></div><!-- Generated from version 0.3.0-pre (apiVersion=0.3, unstable=True) -->
<h1 id="remote-builds"><a class="header" href="#remote-builds">Remote Builds</a></h1>
<p>If the host running Colmena is not powerful enough, consider offloading the actual builds to remote machines.
Colmena supports two ways to achieve this:</p>
<h2 id="using-colmenas-deploymentbuildontarget"><a class="header" href="#using-colmenas-deploymentbuildontarget">Using Colmena's <code>deployment.buildOnTarget</code></a></h2>
<p>If you set <a href="features/../reference/deployment.html#deploymentbuildontarget"><code>deployment.buildOnTarget = true;</code></a> for a node, then the actual build process will be initiated on the node itself.
Colmena will evaluate the configuration locally before copying the derivations to the target node.
You can temporarily enable this for all nodes by passing <code>--build-on-target</code> on the command line, or disable it with <code>--no-build-on-target</code>.</p>
<p>This is most useful in scenarios where the machine running Colmena is bandwidth-constrained, or it's inconvenient to configure designated builders beforehand.
With this method, the build results will <em>not</em> be copied back to the local machine or otherwise shared across the target nodes.
If you have custom packages used on multiple nodes, the work required to build those packages will be duplicated across the nodes.</p>
<h2 id="using-the-native-distributed-build-feature-in-nix"><a class="header" href="#using-the-native-distributed-build-feature-in-nix">Using the native distributed build feature in Nix</a></h2>
<p>When <a href="https://nixos.org/manual/nix/unstable/advanced-topics/distributed-builds.html">distributed build</a> is enabled, Nix will transparently forward builds to the configured builders.
After the builds are done, Nix will copy the results back to the local machine.</p>
<p>Builders can either be configured globally or in your configuration with <a href="features/../reference/meta.html#machinesFile"><code>meta.machinesFile</code></a>.</p>
<div style="break-before: page; page-break-before: always;"></div><!-- Generated from version 0.3.0-pre (apiVersion=0.3, unstable=True) -->
<h1 id="examples"><a class="header" href="#examples">Examples</a></h1>
<p>This section contains examples of setups people commonly use:</p>
<ul>
<li><strong><a href="examples/multi-arch.html">Multi-Architecture Deployments</a></strong> - Deploying to hosts running a foreign architecture</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><!-- Generated from version 0.3.0-pre (apiVersion=0.3, unstable=True) -->
<h1 id="multi-architecture-deployments"><a class="header" href="#multi-architecture-deployments">Multi-Architecture Deployments</a></h1>
<p>You can deploy to hosts running different architectures with a single configuration.
This requires you to either <a href="https://nixos.org/manual/nix/stable/advanced-topics/distributed-builds.html">set up remote builders</a> running the foreign architecture(s), or <a href="https://nixos.wiki/wiki/NixOS_on_ARM#Compiling_through_QEMU">set up binfmt emulation</a> on the host running Colmena.</p>
<h2 id="binfmt-emulation"><a class="header" href="#binfmt-emulation"><code>binfmt</code> Emulation</a></h2>
<p>This following example sets up binfmt, allowing an X86-64 host (<code>laptop</code>) to build derivations for an AArch64 host (<code>rpi</code>) through QEMU:</p>
<pre><code class="language-nix">{
  # The NixOS machine you are running Colmena on (x86_64-linux)
  laptop = { pkgs, ... }: {
    # Enable binfmt emulation for aarch64-linux
    boot.binfmt.emulatedSystems = [ &quot;aarch64-linux&quot; ];

    # ... Rest of configuration ...
  };

  # The remote machine running a foreign architecture (aarch64-linux)
  rpi = { pkgs, ... }: {
    # Override nixpkgs architecture
    nixpkgs.system = &quot;aarch64-linux&quot;;

    # ... Rest of configuration ...
  };
}
</code></pre>
<p><em>(For Flake users, the above attribute set is the value of <code>outputs.colmena</code>)</em></p>
<p>First, deploy the local configuration with <code>colmena apply-local --sudo</code>.
For more information on what is required on the local system, see <a href="examples/../features/apply-local.html">Local Deployment</a>.</p>
<p>After the new configuration is activated, binfmt emulation will be set up on the local machine.
You can then deploy to the <code>rpi</code> node with <code>colmena apply --on rpi</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><!-- Generated from version 0.3.0-pre (apiVersion=0.3, unstable=True) -->
<h1 id="reference"><a class="header" href="#reference">Reference</a></h1>
<!-- UNSTABLE_BEGIN -->
<p>You are currently reading <strong>the unstable version</strong> of the Colmena Manual, built against the tip of <a href="https://github.com/zhaofengli/colmena">the development branch</a>.</p>
<!-- UNSTABLE_END -->
<p>This section contains detailed listings of options and parameters accepted by Colmena:</p>
<ul>
<li><strong><a href="reference/deployment.html">Deployment Options</a></strong></li>
<li><strong><a href="reference/meta.html">Meta Options</a></strong></li>
<li><strong><a href="reference/cli.html">Command Line Arguments</a></strong></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><!-- Generated from version 0.3.0-pre (apiVersion=0.3, unstable=True) -->
<h1 id="deployment-options"><a class="header" href="#deployment-options">Deployment Options</a></h1>
<!-- UNSTABLE_BEGIN -->
<p>You are currently reading <strong>the unstable version</strong> of the Colmena Manual, built against the tip of <a href="https://github.com/zhaofengli/colmena">the development branch</a>.</p>
<!-- UNSTABLE_END -->
<p>Colmena adds a set of extra options that can be used in your NixOS configurations under the <code>deployment</code> prefix.</p>
<!--
    The following is injected by the build system

    Looking to improve the description? Head to `src/nix/hive/eval.nix` in the repo :)
-->
<h2 id="deploymentallowlocaldeployment"><a class="header" href="#deploymentallowlocaldeployment">deployment.allowLocalDeployment</a></h2>
<p>Allow the configuration to be applied locally on the host running
Colmena.</p>
<p>For local deployment to work, all of the following must be true:</p>
<ul>
<li>The node must be running NixOS.</li>
<li>The node must have deployment.allowLocalDeployment set to true.</li>
<li>The node's networking.hostName must match the hostname.</li>
</ul>
<p>To apply the configurations locally, run <code>colmena apply-local</code>.
You can also set deployment.targetHost to null if the nost is not
accessible over SSH (only local deployment will be possible).</p>
<p><em><em>Type</em></em>:
boolean</p>
<p><em><em>Default</em></em></p>
<pre><code>false
</code></pre>
<h2 id="deploymentbuildontarget"><a class="header" href="#deploymentbuildontarget">deployment.buildOnTarget</a></h2>
<p>Whether to build the system profiles on the target node itself.</p>
<p>When enabled, Colmena will copy the derivation to the target
node and initiate the build there. This avoids copying back the
build results involved with the native distributed build
feature. Furthermore, the <code>build</code> goal will be equivalent to
the <code>push</code> goal. Since builds happen on the target node, the
results are automatically &quot;pushed&quot; and won't exist in the local
Nix store.</p>
<p>You can temporarily override per-node settings by passing
<code>--build-on-target</code> (enable for all nodes) or
<code>--no-build-on-target</code> (disable for all nodes) on the command
line.</p>
<p><em><em>Type</em></em>:
boolean</p>
<p><em><em>Default</em></em></p>
<pre><code>false
</code></pre>
<h2 id="deploymentkeys"><a class="header" href="#deploymentkeys">deployment.keys</a></h2>
<p>A set of secrets to be deployed to the node.</p>
<p>Secrets are transferred to the node out-of-band and
never ends up in the Nix store.</p>
<p><em><em>Type</em></em>:
attribute set of submodules</p>
<p><em><em>Default</em></em></p>
<pre><code>{}
</code></pre>
<h2 id="deploymentkeysnamedestdir"><a class="header" href="#deploymentkeysnamedestdir">deployment.keys.&lt;name&gt;.destDir</a></h2>
<p>Destination directory on the host.</p>
<p><em><em>Type</em></em>:
string</p>
<p><em><em>Default</em></em></p>
<pre><code>&quot;/run/keys&quot;
</code></pre>
<h2 id="deploymentkeysnamegroup"><a class="header" href="#deploymentkeysnamegroup">deployment.keys.&lt;name&gt;.group</a></h2>
<p>The group that will own the file.</p>
<p><em><em>Type</em></em>:
string</p>
<p><em><em>Default</em></em></p>
<pre><code>&quot;root&quot;
</code></pre>
<h2 id="deploymentkeysnamekeycommand"><a class="header" href="#deploymentkeysnamekeycommand">deployment.keys.&lt;name&gt;.keyCommand</a></h2>
<p>Command to run to generate the key.
One of <code>text</code>, <code>keyCommand</code> and <code>keyFile</code> must be set.</p>
<p><em><em>Type</em></em>:
null or list of strings</p>
<p><em><em>Default</em></em></p>
<pre><code>null
</code></pre>
<h2 id="deploymentkeysnamekeyfile"><a class="header" href="#deploymentkeysnamekeyfile">deployment.keys.&lt;name&gt;.keyFile</a></h2>
<p>Path of the local file to read the key from.
One of <code>text</code>, <code>keyCommand</code> and <code>keyFile</code> must be set.</p>
<p><em><em>Type</em></em>:
null or path</p>
<p><em><em>Default</em></em></p>
<pre><code>null
</code></pre>
<h2 id="deploymentkeysnamename"><a class="header" href="#deploymentkeysnamename">deployment.keys.&lt;name&gt;.name</a></h2>
<p>File name of the key.</p>
<p><em><em>Type</em></em>:
string</p>
<p><em><em>Default</em></em></p>
<pre><code>&quot;â€¹nameâ€º&quot;
</code></pre>
<h2 id="deploymentkeysnamepermissions"><a class="header" href="#deploymentkeysnamepermissions">deployment.keys.&lt;name&gt;.permissions</a></h2>
<p>Permissions to set for the file.</p>
<p><em><em>Type</em></em>:
string</p>
<p><em><em>Default</em></em></p>
<pre><code>&quot;0600&quot;
</code></pre>
<h2 id="deploymentkeysnametext"><a class="header" href="#deploymentkeysnametext">deployment.keys.&lt;name&gt;.text</a></h2>
<p>Content of the key.
One of <code>text</code>, <code>keyCommand</code> and <code>keyFile</code> must be set.</p>
<p><em><em>Type</em></em>:
null or string</p>
<p><em><em>Default</em></em></p>
<pre><code>null
</code></pre>
<h2 id="deploymentkeysnameuploadat"><a class="header" href="#deploymentkeysnameuploadat">deployment.keys.&lt;name&gt;.uploadAt</a></h2>
<p>When to upload the keys.</p>
<ul>
<li>pre-activation (default): Upload the keys before activating the new system profile.</li>
<li>post-activation: Upload the keys after successfully activating the new system profile.</li>
</ul>
<p>For <code>colmena upload-keys</code>, all keys are uploaded at the same time regardless of the configuration here.</p>
<p><em><em>Type</em></em>:
one of &quot;pre-activation&quot;, &quot;post-activation&quot;</p>
<p><em><em>Default</em></em></p>
<pre><code>&quot;pre-activation&quot;
</code></pre>
<h2 id="deploymentkeysnameuser"><a class="header" href="#deploymentkeysnameuser">deployment.keys.&lt;name&gt;.user</a></h2>
<p>The group that will own the file.</p>
<p><em><em>Type</em></em>:
string</p>
<p><em><em>Default</em></em></p>
<pre><code>&quot;root&quot;
</code></pre>
<h2 id="deploymentprivilegeescalationcommand"><a class="header" href="#deploymentprivilegeescalationcommand">deployment.privilegeEscalationCommand</a></h2>
<p>Command to use to elevate privileges when activating the new profiles on SSH hosts.</p>
<p>This is used on SSH hosts when <code>deployment.targetUser</code> is not <code>root</code>.
The user must be allowed to use the command non-interactively.</p>
<p><em><em>Type</em></em>:
list of strings</p>
<p><em><em>Default</em></em></p>
<pre><code>[&quot;sudo&quot;,&quot;-H&quot;,&quot;--&quot;]
</code></pre>
<h2 id="deploymentreplaceunknownprofiles"><a class="header" href="#deploymentreplaceunknownprofiles">deployment.replaceUnknownProfiles</a></h2>
<p>Allow a configuration to be applied to a host running a profile we
have no knowledge of. By setting this option to false, you reduce
the likelyhood of rolling back changes made via another Colmena user.</p>
<p>Unknown profiles are usually the result of either:</p>
<ul>
<li>The node had a profile applied, locally or by another Colmena.</li>
<li>The host running Colmena garbage-collecting the profile.</li>
</ul>
<p>To force profile replacement on all targeted nodes during apply,
use the flag <code>--force-replace-unknown-profiles</code>.</p>
<p><em><em>Type</em></em>:
boolean</p>
<p><em><em>Default</em></em></p>
<pre><code>true
</code></pre>
<h2 id="deploymenttags"><a class="header" href="#deploymenttags">deployment.tags</a></h2>
<p>A list of tags for the node.</p>
<p>Can be used to select a group of nodes for deployment.</p>
<p><em><em>Type</em></em>:
list of strings</p>
<p><em><em>Default</em></em></p>
<pre><code>[]
</code></pre>
<h2 id="deploymenttargethost"><a class="header" href="#deploymenttargethost">deployment.targetHost</a></h2>
<p>The target SSH node for deployment.</p>
<p>By default, the node's attribute name will be used.
If set to null, only local deployment will be supported.</p>
<p><em><em>Type</em></em>:
null or string</p>
<p><em><em>Default</em></em></p>
<pre><code>&quot;nixos&quot;
</code></pre>
<h2 id="deploymenttargetport"><a class="header" href="#deploymenttargetport">deployment.targetPort</a></h2>
<p>The target SSH port for deployment.</p>
<p>By default, the port is the standard port (22) or taken
from your ssh_config.</p>
<p><em><em>Type</em></em>:
null or unsigned integer, meaning &gt;=0</p>
<p><em><em>Default</em></em></p>
<pre><code>null
</code></pre>
<h2 id="deploymenttargetuser"><a class="header" href="#deploymenttargetuser">deployment.targetUser</a></h2>
<p>The user to use to log into the remote node. If null, login as the
current user.</p>
<p><em><em>Type</em></em>:
null or string</p>
<p><em><em>Default</em></em></p>
<pre><code>&quot;root&quot;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><!-- Generated from version 0.3.0-pre (apiVersion=0.3, unstable=True) -->
<h1 id="meta-options"><a class="header" href="#meta-options">Meta Options</a></h1>
<!-- UNSTABLE_BEGIN -->
<p>You are currently reading <strong>the unstable version</strong> of the Colmena Manual, built against the tip of <a href="https://github.com/zhaofengli/colmena">the development branch</a>.</p>
<!-- UNSTABLE_END -->
<p>The following is a list of options that can be added to the <code>meta</code> attribute set.</p>
<p>For compatibility with NixOps, you may name it <code>network</code> instead of <code>meta</code>.
However, you cannot specify both at the same time.</p>
<!--
    The following is injected by the build system

    Looking to improve the descriptions? Head to `src/nix/hive/eval.nix` in the repo :)
-->
<h2 id="description"><a class="header" href="#description">description</a></h2>
<p>A short description for the configuration.</p>
<p><em><em>Type</em></em>:
string</p>
<p><em><em>Default</em></em></p>
<pre><code>&quot;A Colmena Hive&quot;
</code></pre>
<h2 id="machinesfile"><a class="header" href="#machinesfile">machinesFile</a></h2>
<p>Use the machines listed in this file when building this hive configuration.</p>
<p>If your Colmena host has nix configured to allow for remote builds
(for nix-daemon, your user being included in trusted-users)
you can set a machines file that will be passed to the underlying
nix-store command during derivation realization as a builders option.
For example, if you support multiple orginizations each with their own
build machine(s) you can ensure that builds only take place on your
local machine and/or the machines specified in this file.</p>
<p>See https://nixos.org/manual/nix/stable/#chap-distributed-builds
for the machine specification format.</p>
<p>This option is ignored when builds are initiated on the remote nodes
themselves via <code>deployment.buildOnTarget</code> or <code>--build-on-target</code>. To
still use the Nix distributed build functionality, configure the
builders on the target nodes with <code>nix.buildMachines</code>.</p>
<p><em><em>Type</em></em>:
null or path</p>
<p><em><em>Default</em></em></p>
<pre><code>null
</code></pre>
<h2 id="name"><a class="header" href="#name">name</a></h2>
<p>Name of the configuration.</p>
<p><em><em>Type</em></em>:
string</p>
<p><em><em>Default</em></em></p>
<pre><code>&quot;hive&quot;
</code></pre>
<h2 id="nixpkgs"><a class="header" href="#nixpkgs">nixpkgs</a></h2>
<p>Pinned Nixpkgs. Accepts one of the following:</p>
<ul>
<li>A path to a Nixpkgs checkout</li>
<li>The Nixpkgs lambda (e.g., import <nixpkgs>)</li>
<li>An initialized Nixpkgs attribute set</li>
</ul>
<p>This option must be specified when using Flakes.</p>
<p><em><em>Type</em></em>:
unspecified</p>
<p><em><em>Default</em></em></p>
<pre><code>null
</code></pre>
<h2 id="nodenixpkgs"><a class="header" href="#nodenixpkgs">nodeNixpkgs</a></h2>
<p>Node-specific Nixpkgs overrides.</p>
<p><em><em>Type</em></em>:
attribute set of unspecifieds</p>
<p><em><em>Default</em></em></p>
<pre><code>{}
</code></pre>
<h2 id="specialargs"><a class="header" href="#specialargs">specialArgs</a></h2>
<p>A set of special arguments to be passed to NixOS modules.</p>
<p>This will be merged into the <code>specialArgs</code> used to evaluate
the NixOS configurations.</p>
<p><em><em>Type</em></em>:
attribute set of unspecifieds</p>
<p><em><em>Default</em></em></p>
<pre><code>{}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><!-- Generated from version 0.3.0-pre (apiVersion=0.3, unstable=True) -->
<h1 id="command-line-arguments"><a class="header" href="#command-line-arguments">Command Line Arguments</a></h1>
<!-- UNSTABLE_BEGIN -->
<p>You are currently reading <strong>the unstable version</strong> of the Colmena Manual, built against the tip of <a href="https://github.com/zhaofengli/colmena">the development branch</a>.</p>
<!-- UNSTABLE_END -->
<p>The following are the help messages that will be printed when you invoke any sub-command with <code>--help</code>:</p>
<!--
    The following is injected by the build system

    Looking to improve the help messages? They are located in:

    - src/cli.rs
    - src/command/<subcommand>.rs
-->
<h2 id="colmena"><a class="header" href="#colmena"><code>colmena</code></a></h2>
<pre><div class="hljs"><span style='color:#0a0'>Colmena</span> 0.3.0-pre
Zhaofeng Li &lt;hello@zhaofeng.li&gt;
NixOS deployment tool

Colmena helps you deploy to multiple hosts running NixOS.
For more details, read the manual at &lt;https://zhaofengli.github.io/colmena/0.3&gt;.

Note: You are using a pre-release version of Colmena, so the supported options may be different from what&#39;s in the
manual.
<span style='color:#a50'>
USAGE:</span>
    colmena [FLAGS] [OPTIONS] [SUBCOMMAND]

<span style='color:#a50'>FLAGS:
</span>    <span style='color:#0a0'>-h</span>, <span style='color:#0a0'>--help</span>          
            Prints help information

        <span style='color:#0a0'>--show-trace</span>    
            Passes --show-trace to Nix commands

    <span style='color:#0a0'>-V</span>, <span style='color:#0a0'>--version</span>       
            Prints version information


<span style='color:#a50'>OPTIONS:
</span>    <span style='color:#0a0'>-f</span>, <span style='color:#0a0'>--config</span> <span style='color:#0a0'>&lt;CONFIG&gt;</span>    
            If this argument is not specified, Colmena will search upwards from the current working directory for a file
            named &quot;flake.nix&quot; or &quot;hive.nix&quot;. This behavior is disabled if --config/-f is given explicitly.
            
            For a sample configuration, check the manual at &lt;https://zhaofengli.github.io/colmena/0.3&gt;.
             [default: <span style='color:#0a0'>hive.nix</span>]
        <span style='color:#0a0'>--color</span> <span style='color:#0a0'>&lt;WHEN&gt;</span>       
            When to colorize the output. By default, Colmena enables colorized output when the terminal supports it.
            
            It&#39;s also possible to specify the preference using environment variables. See
            &lt;https://bixense.com/clicolors&gt;.
             [default: <span style='color:#0a0'>auto</span>]  [possible values: <span style='color:#0a0'>auto</span>, <span style='color:#0a0'>always</span>, <span style='color:#0a0'>never</span>]

<span style='color:#a50'>SUBCOMMANDS:
</span>    <span style='color:#0a0'>apply</span>          Apply configurations on remote machines
    <span style='color:#0a0'>apply-local</span>    Apply configurations on the local machine
    <span style='color:#0a0'>build</span>          Build the configuration but not push to remote machines
    <span style='color:#0a0'>eval</span>           Evaluate expressions using the complete configuration
    <span style='color:#0a0'>exec</span>           Run a command on remote machines
    <span style='color:#0a0'>help</span>           Prints this message or the help of the given subcommand(s)
    <span style='color:#0a0'>nix-info</span>       Show information about the current Nix installation
    <span style='color:#0a0'>upload-keys</span>    Upload keys to remote hosts</div></pre>
<h2 id="colmena-apply"><a class="header" href="#colmena-apply"><code>colmena apply</code></a></h2>
<pre><div class="hljs"><span style='color:#0a0'>colmena-apply</span> 
Apply configurations on remote machines
<span style='color:#a50'>
USAGE:</span>
    colmena apply [FLAGS] [OPTIONS] [goal]

<span style='color:#a50'>FLAGS:
</span>        <span style='color:#0a0'>--build-on-target</span>                   
            Build the system profiles on the target nodes themselves.
            
            If enabled, the system profiles will be built on the target nodes themselves, not on the host running
            Colmena itself.
            This overrides per-node perferences set in `deployment.buildOnTarget`.
            To temporarily disable remote build on all nodes, use `--no-build-on-target`.
        <span style='color:#0a0'>--force-replace-unknown-profiles</span>    
            If `deployment.replaceUnknownProfiles` is set for a target, using this switch
            will treat deployment.replaceUnknownProfiles as though it was set true and perform unknown profile
            replacement.
    <span style='color:#0a0'>-h</span>, <span style='color:#0a0'>--help</span>                              
            Prints help information

        <span style='color:#0a0'>--keep-result</span>                       
            Create GC roots for built profiles.
            
            The built system profiles will be added as GC roots so that they will not be removed by the garbage
            collector.
            The links will be created under .gcroots in the directory the Hive configuration is located.
        <span style='color:#0a0'>--no-gzip</span>                           
            Disables the use of gzip when copying closures to the remote host.

        <span style='color:#0a0'>--no-keys</span>                           
            Do not upload secret keys set in `deployment.keys`.
            
            By default, Colmena will upload keys set in `deployment.keys` before deploying the new profile on a node.
            To upload keys without building or deploying the rest of the configuration, use `colmena upload-keys`.
        <span style='color:#0a0'>--no-substitutes</span>                    
            Disables the use of substituters when copying closures to the remote host.

    <span style='color:#0a0'>-V</span>, <span style='color:#0a0'>--version</span>                           
            Prints version information

    <span style='color:#0a0'>-v</span>, <span style='color:#0a0'>--verbose</span>                           
            Deactivates the progress spinner and prints every line of output.


<span style='color:#a50'>OPTIONS:
</span>        <span style='color:#0a0'>--eval-node-limit</span> <span style='color:#0a0'>&lt;LIMIT&gt;</span>    
            Limits the maximum number of hosts to be evaluated at once.
            
            The evaluation process is RAM-intensive. The default behavior is to limit the maximum number of host
            evaluated at the same time based on naive heuristics.
            
            Set to 0 to disable the limit.
             [default: <span style='color:#0a0'>auto</span>]
        <span style='color:#0a0'>--on</span> <span style='color:#0a0'>&lt;NODES&gt;</span>                 
            Select a list of nodes to deploy to.
            
            The list is comma-separated and globs are supported. To match tags, prepend the filter by @. Valid examples:
            
            - host1,host2,host3
            - edge-*
            - edge-*,core-*
            - @a-tag,@tags-can-have-*
    <span style='color:#0a0'>-p</span>, <span style='color:#0a0'>--parallel</span> <span style='color:#0a0'>&lt;LIMIT&gt;</span>           
            Limits the maximum number of hosts to be deployed in parallel.
            
            Set to 0 to disable parallemism limit.
             [default: <span style='color:#0a0'>10</span>]

<span style='color:#a50'>ARGS:
</span>    <span style='color:#0a0'>&lt;goal&gt;</span>    
            Same as the targets for switch-to-configuration.
            &quot;push&quot; means only copying the closures to remote nodes. [default: <span style='color:#0a0'>switch</span>]  [possible values:
            <span style='color:#0a0'>build</span>, <span style='color:#0a0'>push</span>, <span style='color:#0a0'>switch</span>, <span style='color:#0a0'>boot</span>, <span style='color:#0a0'>test</span>, <span style='color:#0a0'>dry-activate</span>, <span style='color:#0a0'>keys</span>]</div></pre>
<h2 id="colmena-apply-local"><a class="header" href="#colmena-apply-local"><code>colmena apply-local</code></a></h2>
<pre><div class="hljs"><span style='color:#0a0'>colmena-apply-local</span> 
Apply configurations on the local machine
<span style='color:#a50'>
USAGE:</span>
    colmena apply-local [FLAGS] [OPTIONS] [goal]

<span style='color:#a50'>FLAGS:
</span>    <span style='color:#0a0'>-h</span>, <span style='color:#0a0'>--help</span>       
            Prints help information

        <span style='color:#0a0'>--no-keys</span>    
            Do not deploy secret keys set in `deployment.keys`.
            
            By default, Colmena will deploy keys set in `deployment.keys` before activating the profile on this host.
        <span style='color:#0a0'>--sudo</span>       
            Attempt to escalate privileges if not run as root

    <span style='color:#0a0'>-V</span>, <span style='color:#0a0'>--version</span>    
            Prints version information

    <span style='color:#0a0'>-v</span>, <span style='color:#0a0'>--verbose</span>    
            Deactivates the progress spinner and prints every line of output.


<span style='color:#a50'>OPTIONS:
</span>        <span style='color:#0a0'>--node</span> <span style='color:#0a0'>&lt;node&gt;</span>               
            Override the node name to use

        <span style='color:#0a0'>--sudo-command</span> <span style='color:#0a0'>&lt;COMMAND&gt;</span>    
            Command to use to escalate privileges [default: <span style='color:#0a0'>sudo</span>]


<span style='color:#a50'>ARGS:
</span>    <span style='color:#0a0'>&lt;goal&gt;</span>    
            Same as the targets for switch-to-configuration.
            &quot;push&quot; is noop in apply-local. [default: <span style='color:#0a0'>switch</span>]  [possible values: <span style='color:#0a0'>push</span>, <span style='color:#0a0'>switch</span>,
            <span style='color:#0a0'>boot</span>, <span style='color:#0a0'>test</span>, <span style='color:#0a0'>dry-activate</span>, <span style='color:#0a0'>keys</span>]</div></pre>
<h2 id="colmena-build"><a class="header" href="#colmena-build"><code>colmena build</code></a></h2>
<pre><div class="hljs"><span style='color:#0a0'>colmena-build</span> 
Build the configuration but not push to remote machines

This subcommand behaves as if you invoked `apply` with the `build` goal.
<span style='color:#a50'>
USAGE:</span>
    colmena build [FLAGS] [OPTIONS]

<span style='color:#a50'>FLAGS:
</span>        <span style='color:#0a0'>--build-on-target</span>                   
            Build the system profiles on the target nodes themselves.
            
            If enabled, the system profiles will be built on the target nodes themselves, not on the host running
            Colmena itself.
            This overrides per-node perferences set in `deployment.buildOnTarget`.
            To temporarily disable remote build on all nodes, use `--no-build-on-target`.
        <span style='color:#0a0'>--force-replace-unknown-profiles</span>    
            If `deployment.replaceUnknownProfiles` is set for a target, using this switch
            will treat deployment.replaceUnknownProfiles as though it was set true and perform unknown profile
            replacement.
    <span style='color:#0a0'>-h</span>, <span style='color:#0a0'>--help</span>                              
            Prints help information

        <span style='color:#0a0'>--keep-result</span>                       
            Create GC roots for built profiles.
            
            The built system profiles will be added as GC roots so that they will not be removed by the garbage
            collector.
            The links will be created under .gcroots in the directory the Hive configuration is located.
        <span style='color:#0a0'>--no-gzip</span>                           
            Disables the use of gzip when copying closures to the remote host.

        <span style='color:#0a0'>--no-keys</span>                           
            Do not upload secret keys set in `deployment.keys`.
            
            By default, Colmena will upload keys set in `deployment.keys` before deploying the new profile on a node.
            To upload keys without building or deploying the rest of the configuration, use `colmena upload-keys`.
        <span style='color:#0a0'>--no-substitutes</span>                    
            Disables the use of substituters when copying closures to the remote host.

    <span style='color:#0a0'>-V</span>, <span style='color:#0a0'>--version</span>                           
            Prints version information

    <span style='color:#0a0'>-v</span>, <span style='color:#0a0'>--verbose</span>                           
            Deactivates the progress spinner and prints every line of output.


<span style='color:#a50'>OPTIONS:
</span>        <span style='color:#0a0'>--eval-node-limit</span> <span style='color:#0a0'>&lt;LIMIT&gt;</span>    
            Limits the maximum number of hosts to be evaluated at once.
            
            The evaluation process is RAM-intensive. The default behavior is to limit the maximum number of host
            evaluated at the same time based on naive heuristics.
            
            Set to 0 to disable the limit.
             [default: <span style='color:#0a0'>auto</span>]
        <span style='color:#0a0'>--on</span> <span style='color:#0a0'>&lt;NODES&gt;</span>                 
            Select a list of nodes to deploy to.
            
            The list is comma-separated and globs are supported. To match tags, prepend the filter by @. Valid examples:
            
            - host1,host2,host3
            - edge-*
            - edge-*,core-*
            - @a-tag,@tags-can-have-*
    <span style='color:#0a0'>-p</span>, <span style='color:#0a0'>--parallel</span> <span style='color:#0a0'>&lt;LIMIT&gt;</span>           
            Limits the maximum number of hosts to be deployed in parallel.
            
            Set to 0 to disable parallemism limit.
             [default: <span style='color:#0a0'>10</span>]</div></pre>
<h2 id="colmena-upload-keys"><a class="header" href="#colmena-upload-keys"><code>colmena upload-keys</code></a></h2>
<pre><div class="hljs"><span style='color:#0a0'>colmena-upload-keys</span> 
Upload keys to remote hosts

This subcommand behaves as if you invoked `apply` with the pseudo `keys` goal.
<span style='color:#a50'>
USAGE:</span>
    colmena upload-keys [FLAGS] [OPTIONS]

<span style='color:#a50'>FLAGS:
</span>        <span style='color:#0a0'>--build-on-target</span>                   
            Build the system profiles on the target nodes themselves.
            
            If enabled, the system profiles will be built on the target nodes themselves, not on the host running
            Colmena itself.
            This overrides per-node perferences set in `deployment.buildOnTarget`.
            To temporarily disable remote build on all nodes, use `--no-build-on-target`.
        <span style='color:#0a0'>--force-replace-unknown-profiles</span>    
            If `deployment.replaceUnknownProfiles` is set for a target, using this switch
            will treat deployment.replaceUnknownProfiles as though it was set true and perform unknown profile
            replacement.
    <span style='color:#0a0'>-h</span>, <span style='color:#0a0'>--help</span>                              
            Prints help information

        <span style='color:#0a0'>--keep-result</span>                       
            Create GC roots for built profiles.
            
            The built system profiles will be added as GC roots so that they will not be removed by the garbage
            collector.
            The links will be created under .gcroots in the directory the Hive configuration is located.
        <span style='color:#0a0'>--no-gzip</span>                           
            Disables the use of gzip when copying closures to the remote host.

        <span style='color:#0a0'>--no-keys</span>                           
            Do not upload secret keys set in `deployment.keys`.
            
            By default, Colmena will upload keys set in `deployment.keys` before deploying the new profile on a node.
            To upload keys without building or deploying the rest of the configuration, use `colmena upload-keys`.
        <span style='color:#0a0'>--no-substitutes</span>                    
            Disables the use of substituters when copying closures to the remote host.

    <span style='color:#0a0'>-V</span>, <span style='color:#0a0'>--version</span>                           
            Prints version information

    <span style='color:#0a0'>-v</span>, <span style='color:#0a0'>--verbose</span>                           
            Deactivates the progress spinner and prints every line of output.


<span style='color:#a50'>OPTIONS:
</span>        <span style='color:#0a0'>--eval-node-limit</span> <span style='color:#0a0'>&lt;LIMIT&gt;</span>    
            Limits the maximum number of hosts to be evaluated at once.
            
            The evaluation process is RAM-intensive. The default behavior is to limit the maximum number of host
            evaluated at the same time based on naive heuristics.
            
            Set to 0 to disable the limit.
             [default: <span style='color:#0a0'>auto</span>]
        <span style='color:#0a0'>--on</span> <span style='color:#0a0'>&lt;NODES&gt;</span>                 
            Select a list of nodes to deploy to.
            
            The list is comma-separated and globs are supported. To match tags, prepend the filter by @. Valid examples:
            
            - host1,host2,host3
            - edge-*
            - edge-*,core-*
            - @a-tag,@tags-can-have-*
    <span style='color:#0a0'>-p</span>, <span style='color:#0a0'>--parallel</span> <span style='color:#0a0'>&lt;LIMIT&gt;</span>           
            Limits the maximum number of hosts to be deployed in parallel.
            
            Set to 0 to disable parallemism limit.
             [default: <span style='color:#0a0'>10</span>]</div></pre>
<h2 id="colmena-eval"><a class="header" href="#colmena-eval"><code>colmena eval</code></a></h2>
<pre><div class="hljs"><span style='color:#0a0'>colmena-eval</span> 
Evaluate expressions using the complete configuration

Your expression should take an attribute set with keys `pkgs`, `lib` and `nodes` (like a NixOS module) and return a
JSON-serializable value.

For example, to retrieve the configuration of one node, you may write something like:

    { nodes, ... }: nodes.node-a.config.networking.hostName
<span style='color:#a50'>
USAGE:</span>
    colmena eval [FLAGS] [OPTIONS] [FILE]

<span style='color:#a50'>FLAGS:
</span>    <span style='color:#0a0'>-h</span>, <span style='color:#0a0'>--help</span>           
            Prints help information

        <span style='color:#0a0'>--instantiate</span>    
            Actually instantiate the expression

    <span style='color:#0a0'>-V</span>, <span style='color:#0a0'>--version</span>        
            Prints version information


<span style='color:#a50'>OPTIONS:
</span>    <span style='color:#0a0'>-E</span> <span style='color:#0a0'>&lt;EXPRESSION&gt;</span>        
            The Nix expression


<span style='color:#a50'>ARGS:
</span>    <span style='color:#0a0'>&lt;FILE&gt;</span>    
            The .nix file containing the expression
</div></pre>
<h2 id="colmena-exec"><a class="header" href="#colmena-exec"><code>colmena exec</code></a></h2>
<pre><div class="hljs"><span style='color:#0a0'>colmena-exec</span> 
Run a command on remote machines
<span style='color:#a50'>
USAGE:</span>
    colmena exec [FLAGS] [OPTIONS] [--] &lt;COMMAND&gt;...

<span style='color:#a50'>FLAGS:
</span>    <span style='color:#0a0'>-h</span>, <span style='color:#0a0'>--help</span>       
            Prints help information

    <span style='color:#0a0'>-V</span>, <span style='color:#0a0'>--version</span>    
            Prints version information

    <span style='color:#0a0'>-v</span>, <span style='color:#0a0'>--verbose</span>    
            Deactivates the progress spinner and prints every line of output.


<span style='color:#a50'>OPTIONS:
</span>        <span style='color:#0a0'>--on</span> <span style='color:#0a0'>&lt;NODES&gt;</span>          
            Select a list of nodes to deploy to.
            
            The list is comma-separated and globs are supported. To match tags, prepend the filter by @. Valid examples:
            
            - host1,host2,host3
            - edge-*
            - edge-*,core-*
            - @a-tag,@tags-can-have-*
    <span style='color:#0a0'>-p</span>, <span style='color:#0a0'>--parallel</span> <span style='color:#0a0'>&lt;LIMIT&gt;</span>    
            Limits the maximum number of hosts to run the command in parallel.
            
            In `colmena exec`, the parallelism limit is disabled (0) by default.
             [default: <span style='color:#0a0'>0</span>]

<span style='color:#a50'>ARGS:
</span>    <span style='color:#0a0'>&lt;COMMAND&gt;</span><span style='color:#0a0'>...</span>    
            Command to run
            
            It&#39;s recommended to use -- to separate Colmena options from the command to run. For example:
            
                colmena exec --on @routers -- tcpdump -vni any ip[9] == 89</div></pre>
<h2 id="colmena-nix-info"><a class="header" href="#colmena-nix-info"><code>colmena nix-info</code></a></h2>
<pre><div class="hljs"><span style='color:#0a0'>colmena-nix-info</span> 
Show information about the current Nix installation
<span style='color:#a50'>
USAGE:</span>
    colmena nix-info

<span style='color:#a50'>FLAGS:
</span>    <span style='color:#0a0'>-h</span>, <span style='color:#0a0'>--help</span>       
            Prints help information

    <span style='color:#0a0'>-V</span>, <span style='color:#0a0'>--version</span>    
            Prints version information
</div></pre>
<div style="break-before: page; page-break-before: always;"></div><!-- Generated from version 0.3.0-pre (apiVersion=0.3, unstable=True) -->
<h1 id="contributing"><a class="header" href="#contributing">Contributing</a></h1>
<p>Contributions are welcome!</p>
<h2 id="code"><a class="header" href="#code">Code</a></h2>
<p>You can checkout the source code and submit pull requests at <a href="https://github.com/zhaofengli/colmena">the GitHub repo</a>.</p>
<p>By contributing code to Colmena, you agree that your contributions will be available under <a href="https://github.com/zhaofengli/colmena/blob/main/LICENSE">the MIT License</a>.</p>
<h2 id="issues--feature-requests"><a class="header" href="#issues--feature-requests">Issues &amp; Feature Requests</a></h2>
<p>Bumped into a problem? We would like to fix it!
Please open a new issue at <a href="https://github.com/zhaofengli/colmena">the GitHub repo</a>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
                        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
                
    </body>
</html>
